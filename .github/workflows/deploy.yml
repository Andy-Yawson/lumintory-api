name: Deploy Zinnvy APIs

on:
  push:
    branches:
      - develop
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy via SSH üßû‚Äç‚ôÇÔ∏è
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "Determining target directory and branch..."
            if [ "${GITHUB_REF##*/}" = "master" ]; then
              APP_DIR="/var/www/zinnvy-api"
              GIT_BRANCH="master"
            else
              APP_DIR="/var/www/zinnvy-api-test"
              GIT_BRANCH="develop"
            fi

            echo "Using app directory: $APP_DIR"
            echo "Using git branch: $GIT_BRANCH"

            echo "Marking the directory as safe for Git..."
            sudo git config --global --add safe.directory "$APP_DIR"

            echo "Starting deployment..."
            cd "$APP_DIR" || { echo "Failed to navigate to project directory"; exit 1; }

            echo "Pulling latest code..."
            sudo git fetch origin
            sudo git checkout "$GIT_BRANCH"
            sudo git reset --hard "origin/$GIT_BRANCH"
            sudo git pull origin "$GIT_BRANCH"

            echo "Installing composer dependencies..."
            sudo composer install --no-dev --no-interaction --no-progress --prefer-dist --optimize-autoloader

            echo "Migrating database..."
            sudo php artisan migrate --force

            echo "Database Seeding..."
            sudo php artisan db:seed --force

            echo "Linking storage..."
            sudo php artisan storage:link || true

            echo "Fixing file ownership and permissions..."
            sudo chown -R ubuntu:www-data storage bootstrap/cache
            sudo chmod -R ug+rwx storage bootstrap/cache storage/logs

            echo "Clearing caches..."
            sudo php artisan route:clear
            sudo php artisan cache:clear || true
            sudo php artisan config:clear

            echo "Optimizing application..."
            sudo php artisan optimize || true

            echo "Dumping autoload..."
            sudo composer dump-autoload

            echo "Restarting Laravel queues..."
            sudo php artisan queue:restart

            echo "Restarting Supervisor workers..."
            sudo supervisorctl reread
            sudo supervisorctl update
            sudo supervisorctl restart all

            echo "Final config clear..."
            sudo php artisan config:clear

            echo "Deployment completed successfully! üéâ"
